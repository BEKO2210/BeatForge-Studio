---
phase: 08-background-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/background/types.ts
  - src/background/BackgroundRenderer.tsx
  - src/background/index.ts
  - src/components/BackgroundEditor.tsx
  - src/visualizers/VisualizerContainer.tsx
  - src/App.tsx
  - src/App.css
autonomous: true

must_haves:
  truths:
    - "User can select solid color backgrounds"
    - "User can create linear and radial gradient backgrounds"
    - "User can upload image as background"
    - "Background renders behind all other layers (visualizers, text)"
  artifacts:
    - path: "src/background/types.ts"
      provides: "Background type definitions and defaults"
      exports: ["BackgroundConfig", "SolidBackground", "GradientBackground", "ImageBackground", "DEFAULT_BACKGROUND"]
    - path: "src/background/BackgroundRenderer.tsx"
      provides: "Headless component rendering background on canvas"
      exports: ["BackgroundRenderer"]
    - path: "src/components/BackgroundEditor.tsx"
      provides: "UI for selecting background type and settings"
      exports: ["BackgroundEditor"]
  key_links:
    - from: "src/App.tsx"
      to: "src/components/BackgroundEditor.tsx"
      via: "backgroundConfig state passed to editor"
      pattern: "backgroundConfig.*setBackgroundConfig"
    - from: "src/visualizers/VisualizerContainer.tsx"
      to: "src/background/BackgroundRenderer.tsx"
      via: "renders background on 'background' layer"
      pattern: "BackgroundRenderer.*renderer"
---

<objective>
Implement customizable background system with solid colors, gradients, and image upload.

Purpose: Allow users to set visual backdrop for their music visualizations, supporting the four preset styles (TikTok, YouTube, Lyric Video, Club).
Output: BackgroundRenderer component, BackgroundEditor UI, integrated with existing canvas system.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

**Existing architecture:**
- Renderer has layer priority: background (0), visualizer (10), overlay (20), text (100)
- Current backgroundColor is simple string (#1a1a1a) passed to Renderer config
- VisualizerContainer orchestrates visualizers and text layers
- App.tsx manages global state (audio, text layers)

**Pattern to follow:**
- TextLayerRenderer pattern: headless component that registers render callback with renderer.onRender()
- Use 'background' layer to render behind all visualizers

@src/renderer/Renderer.ts
@src/visualizers/VisualizerContainer.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create background types and defaults</name>
  <files>src/background/types.ts, src/background/index.ts</files>
  <action>
Create type definitions for background system:

**src/background/types.ts:**
```typescript
// Three background types: solid, gradient, image

export interface SolidBackground {
  type: 'solid';
  color: string; // CSS color
}

export interface GradientStop {
  color: string;
  position: number; // 0-1
}

export interface GradientBackground {
  type: 'gradient';
  gradientType: 'linear' | 'radial';
  angle: number; // degrees (for linear)
  stops: GradientStop[];
}

export interface ImageBackground {
  type: 'image';
  src: string; // data URL or blob URL
  fit: 'cover' | 'contain' | 'stretch';
  opacity: number; // 0-1
}

export type BackgroundConfig = SolidBackground | GradientBackground | ImageBackground;

export const DEFAULT_BACKGROUND: BackgroundConfig = {
  type: 'solid',
  color: '#1a1a1a',
};
```

**src/background/index.ts:**
- Export all types and defaults
- Export BackgroundRenderer (will be created in Task 2)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Background types defined with solid, gradient, and image variants</done>
</task>

<task type="auto">
  <name>Task 2: Create BackgroundRenderer component</name>
  <files>src/background/BackgroundRenderer.tsx, src/background/index.ts</files>
  <action>
Create headless component following TextLayerRenderer pattern:

**BackgroundRenderer.tsx:**
```typescript
interface BackgroundRendererProps {
  renderer: Renderer | null;
  config: BackgroundConfig;
  width: number;
  height: number;
}
```

**Render logic by type:**

1. **Solid:** Simple `ctx.fillStyle = color; ctx.fillRect(0, 0, w, h);`

2. **Gradient:**
   - Linear: `ctx.createLinearGradient()` with angle-based start/end points
   - Radial: `ctx.createRadialGradient()` from center
   - Apply each stop from config.stops

3. **Image:**
   - Store loaded Image in useRef (load when src changes)
   - Apply fit mode:
     - cover: scale to fill, crop overflow
     - contain: scale to fit, letterbox
     - stretch: fill exact dimensions
   - Apply opacity via globalAlpha

**Registration:**
- Use `renderer.onRender(callback, 'background')` to register at priority 0
- Effect cleanup returns unsubscribe function

**Image loading:**
- useEffect to load image when config.type === 'image' and src changes
- Handle load errors gracefully (fallback to solid color)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>BackgroundRenderer renders solid, gradient, and image backgrounds on canvas</done>
</task>

<task type="auto">
  <name>Task 3: Create BackgroundEditor UI and integrate</name>
  <files>src/components/BackgroundEditor.tsx, src/visualizers/VisualizerContainer.tsx, src/App.tsx, src/App.css</files>
  <action>
**BackgroundEditor.tsx:**
Create collapsible editor panel (similar to TextEditor pattern):

```typescript
interface BackgroundEditorProps {
  config: BackgroundConfig;
  onConfigChange: (config: BackgroundConfig) => void;
  disabled?: boolean;
}
```

**UI sections:**
1. **Type selector:** Radio/toggle for Solid | Gradient | Image

2. **Solid controls:**
   - Color picker input

3. **Gradient controls:**
   - Gradient type toggle: Linear | Radial
   - Angle slider (0-360) for linear
   - Gradient stops editor:
     - Show 2-4 color stops
     - Each stop: color picker + position slider (0-100%)
     - Add/remove stop buttons

4. **Image controls:**
   - File upload button (accept: image/*)
   - Fit mode selector: Cover | Contain | Stretch
   - Opacity slider (0-100%)
   - Preview thumbnail

**VisualizerContainer.tsx:**
- Add backgroundConfig prop
- Render BackgroundRenderer before visualizers
- Pass renderer, config, width, height

**App.tsx:**
- Add `const [backgroundConfig, setBackgroundConfig] = useState<BackgroundConfig>(DEFAULT_BACKGROUND)`
- Render BackgroundEditor in player container
- Pass backgroundConfig to VisualizerContainer

**App.css:**
- Style background editor similar to text editor
- Mobile-first responsive layout
  </action>
  <verify>
1. `npm run build` succeeds
2. Run dev server, open app, verify background editor appears
3. Change to solid color - canvas updates
4. Change to gradient - canvas shows gradient
5. Upload image - canvas shows image background
  </verify>
  <done>BackgroundEditor UI allows selecting and customizing all three background types</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npx tsc --noEmit` passes (no type errors)
- [ ] Solid color background renders correctly
- [ ] Linear and radial gradients render correctly
- [ ] Image upload works with cover/contain/stretch modes
- [ ] Background renders behind visualizers and text (layer priority)
- [ ] UI is responsive on mobile
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- BG-01 satisfied: Solid color backgrounds work
- BG-02 satisfied: Gradient backgrounds work (linear and radial)
- BG-03 satisfied: Image backgrounds work with upload
- Background renders at priority 0 (behind everything)
</success_criteria>

<output>
After completion, create `.planning/phases/08-background-system/08-01-SUMMARY.md`
</output>
