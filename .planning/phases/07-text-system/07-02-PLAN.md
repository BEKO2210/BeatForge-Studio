---
phase: 07-text-system
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/text/TextLayer.tsx
  - src/components/TextEditor.tsx
  - src/App.tsx
  - src/App.css
autonomous: false

must_haves:
  truths:
    - "User can add a text layer via UI"
    - "Text renders on canvas with correct styling"
    - "Text animation options work (fade, slide, scale)"
    - "Font family and size can be customized"
    - "Text position can be adjusted"
  artifacts:
    - path: "src/text/TextLayer.tsx"
      provides: "React component rendering text on canvas"
      exports: ["TextLayerRenderer"]
    - path: "src/components/TextEditor.tsx"
      provides: "UI for adding/editing text layers"
      exports: ["TextEditor"]
  key_links:
    - from: "src/text/TextLayer.tsx"
      to: "src/text/TextRenderer.ts"
      via: "imports renderTextLayer"
      pattern: "import.*renderTextLayer.*from"
    - from: "src/App.tsx"
      to: "src/text/TextLayer.tsx"
      via: "renders TextLayerRenderer"
      pattern: "<TextLayerRenderer"
    - from: "src/App.tsx"
      to: "src/components/TextEditor.tsx"
      via: "renders TextEditor"
      pattern: "<TextEditor"
---

<objective>
Build text component, editor UI, and integrate into the app.

Purpose: Enable users to add, style, and animate text layers on the canvas.
Output: Working text system with UI for managing text layers.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-text-system/07-01-SUMMARY.md

# Existing patterns to follow:
@src/visualizers/EqualizerVisualizer.tsx
@src/visualizers/VisualizerContainer.tsx
@src/components/AudioPlayer.tsx
@src/App.tsx
@src/App.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TextLayerRenderer component</name>
  <files>src/text/TextLayer.tsx</files>
  <action>
Create a React component that renders text layers on the canvas:

1. Export interface TextLayerRendererProps:
   - renderer: Renderer | null (from renderer module)
   - layers: TextLayer[] (array of text layers to render)
   - isBeat: boolean
   - beatIntensity: number
   - width: number
   - height: number

2. Export function component TextLayerRenderer(props): null
   - Follow the same pattern as EqualizerVisualizer (returns null, only registers render callback)
   - Use useBeatReaction hook for beat-reactive text (pulse animation)
   - Store refs for current values (layers, dimensions, reaction)

3. Implementation:
   - useEffect to register render callback with renderer.onRender()
   - In render callback:
     - Iterate through layers
     - For each visible layer:
       - If layer.animation !== 'none', calculate animationState using calculateTextAnimation
       - Progress should be 1 (fully visible) for now - timing will be added in effects phase
       - Pass beatReaction value for 'pulse' animation
       - Call renderTextLayer(ctx, layer, width, height, animationState)

4. Update src/text/index.ts to export TextLayerRenderer

Pattern notes:
- Use useEffect with renderer dependency, return unsubscribe function
- Store layer data in refs updated by separate useEffect (React 19 pattern)
- Component renders null (headless render callback pattern)
  </action>
  <verify>tsc --noEmit passes</verify>
  <done>TextLayerRenderer component renders text layers on canvas</done>
</task>

<task type="auto">
  <name>Task 2: Create TextEditor UI component</name>
  <files>src/components/TextEditor.tsx, src/App.css</files>
  <action>
Create a UI component for managing text layers:

1. Export interface TextEditorProps:
   - layers: TextLayer[]
   - onLayersChange: (layers: TextLayer[]) => void
   - disabled?: boolean

2. Export function component TextEditor(props)

3. UI Features:
   - "Add Text" button to create a new layer with defaults:
     - id: crypto.randomUUID()
     - content: 'New Text'
     - position: { x: 0.5, y: 0.5, anchor: 'center' }
     - style: { fontFamily: 'Inter, system-ui, sans-serif', fontSize: 32, fontWeight: 'bold', color: '#ffffff' }
     - animation: 'none'
     - beatReactive: false
     - visible: true

   - For each layer, show collapsible card with:
     - Text input for content
     - Position controls: X/Y sliders (0-100%), anchor dropdown
     - Style controls:
       - Font family dropdown: ['Inter', 'Arial', 'Georgia', 'Courier New', 'Impact']
       - Font size slider: 12-120px
       - Font weight: normal/bold toggle
       - Color picker (input type="color")
     - Animation dropdown: none, fade, slide-up, slide-down, slide-left, slide-right, scale, pulse
     - Beat reactive toggle checkbox
     - Visibility toggle
     - Delete button

4. CSS classes in App.css:
   - .text-editor - container with padding
   - .text-editor-header - flex row with title and add button
   - .text-editor-layer - card for each layer
   - .text-editor-layer-header - layer title with expand/delete
   - .text-editor-field - label + input pair
   - .text-editor-row - flex row for grouped controls
   - Style to match existing app theme (dark background, white/gray text)
  </action>
  <verify>tsc --noEmit passes, no React warnings</verify>
  <done>TextEditor UI allows adding, editing, and removing text layers</done>
</task>

<task type="auto">
  <name>Task 3: Integrate text system into App</name>
  <files>src/App.tsx, src/visualizers/VisualizerContainer.tsx</files>
  <action>
Connect the text system to the main app:

1. In App.tsx:
   - Import TextLayer type from src/text
   - Add state: const [textLayers, setTextLayers] = useState<TextLayer[]>([])
   - Render TextEditor below the player controls (inside app-player-container):
     ```tsx
     <TextEditor
       layers={textLayers}
       onLayersChange={setTextLayers}
       disabled={isLoading}
     />
     ```
   - Pass textLayers to VisualizerContainer:
     ```tsx
     <VisualizerContainer audioEngine={audioEngine} textLayers={textLayers} />
     ```

2. In VisualizerContainer.tsx:
   - Add textLayers prop: textLayers?: TextLayer[]
   - Import TextLayerRenderer from src/text
   - Render TextLayerRenderer after the visualizer components:
     ```tsx
     <TextLayerRenderer
       renderer={renderer}
       layers={textLayers ?? []}
       isBeat={beatInfo?.isBeat ?? false}
       beatIntensity={beatInfo?.intensity ?? 0}
       width={renderer?.width ?? 800}
       height={renderer?.height ?? 400}
     />
     ```
   - Text renders on top of visualizers (rendered after in same canvas)

Note: The render order in the Renderer class processes callbacks in registration order, so TextLayerRenderer registering after visualizers means text draws on top.
  </action>
  <verify>npm run build succeeds, app loads without errors</verify>
  <done>Text system integrated - text layers render on canvas</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete text system with UI for adding/editing styled, animated text layers</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Upload an audio file
    3. Click "Add Text" in the TextEditor panel
    4. Type some text content - verify it appears on canvas
    5. Adjust position sliders - text should move
    6. Change font size - text should resize
    7. Pick a color - text should change color
    8. Select "pulse" animation and enable "Beat Reactive"
    9. Play audio - text should pulse with the beat
    10. Try "fade" and "scale" animations - should animate smoothly
    11. Add a second text layer - both should render
    12. Delete a layer - should be removed
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] Text layers render correctly on canvas
- [ ] All animation types work
- [ ] Beat-reactive pulse works with audio
- [ ] UI allows full control of text properties
- [ ] Human verification passed
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human approved text system functionality
- Phase 7 success criteria met:
  1. User can add text layers with custom content ✓
  2. Text has animation options (fade, slide, scale) ✓
  3. Font family and size can be customized ✓
  4. Text can be positioned anywhere on canvas ✓
</success_criteria>

<output>
After completion, create `.planning/phases/07-text-system/07-02-SUMMARY.md`
</output>
