---
phase: 04-canvas-renderer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/renderer/types.ts
  - src/renderer/Renderer.ts
  - src/renderer/shapes.ts
  - src/hooks/useRenderer.ts
  - src/App.tsx
  - src/App.css
autonomous: true

must_haves:
  truths:
    - "Canvas renders at consistent 60 FPS"
    - "Canvas resizes responsively without distortion"
    - "Basic shapes render correctly on canvas"
  artifacts:
    - path: "src/renderer/Renderer.ts"
      provides: "Canvas render loop with 60 FPS targeting"
      min_lines: 50
      exports: ["Renderer"]
    - path: "src/renderer/shapes.ts"
      provides: "Shape drawing primitives"
      exports: ["drawRect", "drawCircle", "drawLine"]
    - path: "src/hooks/useRenderer.ts"
      provides: "React hook for renderer lifecycle"
      exports: ["useRenderer"]
  key_links:
    - from: "src/hooks/useRenderer.ts"
      to: "src/renderer/Renderer.ts"
      via: "instantiation and lifecycle management"
      pattern: "new Renderer"
    - from: "src/App.tsx"
      to: "src/hooks/useRenderer.ts"
      via: "hook usage for canvas rendering"
      pattern: "useRenderer"
---

<objective>
Create Canvas 2D rendering engine with 60 FPS render loop and basic shape primitives.

Purpose: Establish the visual rendering foundation that visualizers will draw to in Phase 5.
Output: Renderer class, shape primitives, React hook, and integrated canvas in App.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (requestAnimationFrame patterns established)
@.planning/phases/02-audio-engine/02-01-SUMMARY.md

# Existing source files
@src/App.tsx
@src/audio/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Renderer class with Canvas 2D setup and render loop</name>
  <files>src/renderer/types.ts, src/renderer/Renderer.ts</files>
  <action>
Create renderer types and Renderer class:

**src/renderer/types.ts:**
- RendererConfig interface: width, height, backgroundColor (optional)
- RenderCallback type: (ctx: CanvasRenderingContext2D, deltaTime: number) => void
- RendererState type: 'idle' | 'running' | 'stopped'

**src/renderer/Renderer.ts:**
- Constructor takes canvas element and optional config
- Canvas setup: get 2D context, set initial size, handle devicePixelRatio for crisp rendering
- Render loop using requestAnimationFrame with deltaTime tracking
- Methods: start(), stop(), resize(width, height), onRender(callback), getContext()
- Track FPS internally (calculate from deltaTime)
- Clear canvas each frame with backgroundColor before calling render callbacks
- Proper cleanup: cancel animation frame on stop/dispose

**Key patterns:**
- Use Set for render callbacks (multiple visualizers can register)
- Scale canvas context by devicePixelRatio but expose logical size
- deltaTime in milliseconds for animations
  </action>
  <verify>npm run build succeeds, TypeScript compiles without errors</verify>
  <done>Renderer class exists with start/stop/resize/onRender methods and types exported</done>
</task>

<task type="auto">
  <name>Task 2: Create shape drawing primitives</name>
  <files>src/renderer/shapes.ts</files>
  <action>
Create stateless shape drawing functions:

**drawRect(ctx, x, y, width, height, options?):**
- Options: fillColor, strokeColor, strokeWidth, cornerRadius (optional rounded rect)
- Use ctx.roundRect() if cornerRadius provided (supported in modern browsers)

**drawCircle(ctx, centerX, centerY, radius, options?):**
- Options: fillColor, strokeColor, strokeWidth
- Use ctx.arc() with full circle (0 to 2Ï€)

**drawLine(ctx, x1, y1, x2, y2, options?):**
- Options: color, width, lineCap ('butt' | 'round' | 'square')

**Common pattern:**
- Each function saves context state, applies styles, draws, restores state
- Default colors if not specified (use neutral gray)
- All coordinates in logical pixels (Renderer handles DPR scaling)

Export all functions and ShapeOptions type.
  </action>
  <verify>npm run build succeeds, shapes.ts exports drawRect, drawCircle, drawLine</verify>
  <done>Three shape primitives available for rendering</done>
</task>

<task type="auto">
  <name>Task 3: Create useRenderer hook and integrate into App</name>
  <files>src/hooks/useRenderer.ts, src/App.tsx, src/App.css</files>
  <action>
**src/hooks/useRenderer.ts:**
- Hook takes: canvasRef (RefObject&lt;HTMLCanvasElement&gt;), optional config
- Create Renderer instance when canvas ref available
- Start render loop automatically
- Handle resize via ResizeObserver on canvas parent
- Return: { renderer, isRunning }
- Cleanup: stop renderer and disconnect observer on unmount

**src/App.tsx changes:**
- Add canvas element with ref below beat debug (or in main area)
- Use useRenderer hook with canvas ref
- Register demo render callback that draws:
  - Background clear (dark gray #1a1a1a)
  - Three shapes using primitives: a rect, circle, and line
  - Animate at least one shape (e.g., circle radius pulses based on time)
- Canvas should fill available width, fixed height (400px)

**src/App.css changes:**
- Style canvas container with proper sizing
- Canvas should have display: block to prevent inline spacing issues

**Verification:**
- Canvas visible in app when running dev server
- Shapes render and animate smoothly
- Resize browser window: canvas resizes without distortion
  </action>
  <verify>npm run dev shows animated canvas with shapes, resize works correctly</verify>
  <done>Canvas renders 60 FPS with animated shapes, responsive resize works</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] Canvas visible at http://localhost:5173
- [ ] Shapes (rect, circle, line) render on canvas
- [ ] At least one shape animates smoothly
- [ ] Browser resize causes canvas resize without distortion
- [ ] No console errors during normal operation
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Canvas renders at 60 FPS (can verify via browser DevTools performance tab)
- Renderer class provides clean API for future visualizers
- Responsive canvas sizing works on window resize
</success_criteria>

<output>
After completion, create `.planning/phases/04-canvas-renderer/04-01-SUMMARY.md`
</output>
