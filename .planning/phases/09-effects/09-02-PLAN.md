---
phase: 09-effects
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/effects/particles/types.ts
  - src/effects/particles/Particle.ts
  - src/effects/particles/ParticleSystem.ts
  - src/effects/particles/index.ts
  - src/effects/ParticleRenderer.tsx
  - src/visualizers/VisualizerContainer.tsx
  - src/effects/index.ts
autonomous: false

must_haves:
  truths:
    - "Particles emit on detected beats"
    - "Particles animate smoothly (position, opacity, size)"
    - "Particles fade out and are recycled"
    - "Particle system runs at 60 FPS without frame drops"
  artifacts:
    - path: "src/effects/particles/ParticleSystem.ts"
      provides: "Particle pool and emission logic"
      exports: ["ParticleSystem"]
      min_lines: 80
    - path: "src/effects/ParticleRenderer.tsx"
      provides: "React component for particle rendering"
      exports: ["ParticleRenderer"]
  key_links:
    - from: "src/effects/ParticleRenderer.tsx"
      to: "src/effects/particles/ParticleSystem.ts"
      via: "System reference"
      pattern: "ParticleSystem"
    - from: "src/visualizers/VisualizerContainer.tsx"
      to: "src/effects/ParticleRenderer.tsx"
      via: "Component rendering"
      pattern: "ParticleRenderer"
---

<objective>
Implement a particle system that emits particles on beats for dynamic visual effects.

Purpose: Add energy and motion with beat-reactive particles that enhance the music visualization experience.
Output: ParticleSystem class, ParticleRenderer component, integrated into VisualizerContainer.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-beat-reactivity/06-02-SUMMARY.md

@src/renderer/Renderer.ts
@src/animation/easing.ts
@src/visualizers/VisualizerContainer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create particle types and Particle class</name>
  <files>src/effects/particles/types.ts, src/effects/particles/Particle.ts, src/effects/particles/index.ts</files>
  <action>
    Create particle foundation:

    1. **src/effects/particles/types.ts**:
       ```ts
       export interface ParticleConfig {
         maxParticles: number;      // Pool size (default: 200)
         emitCount: number;         // Particles per beat (default: 15)
         lifetime: number;          // Lifespan in ms (default: 1500)
         minSize: number;           // Min radius (default: 2)
         maxSize: number;           // Max radius (default: 8)
         minSpeed: number;          // Min velocity (default: 50)
         maxSpeed: number;          // Max velocity (default: 200)
         gravity: number;           // Downward acceleration (default: 100)
         colors: string[];          // Particle colors (default: neon palette)
       }

       export interface ParticleState {
         x: number;
         y: number;
         vx: number;
         vy: number;
         size: number;
         color: string;
         life: number;      // Remaining life 0-1
         maxLife: number;   // Total lifespan in ms
         active: boolean;
       }
       ```

    2. **src/effects/particles/Particle.ts**: Class managing single particle:
       - constructor(config: Partial<ParticleConfig>)
       - spawn(x, y, intensity): Initialize at position with velocity based on intensity
       - update(deltaTime): Update position, apply gravity, decrease life
       - isAlive(): boolean - returns life > 0 && active
       - getState(): ParticleState for rendering

       Spawn logic:
       - Random angle (0 to 2*PI for explosion pattern)
       - Speed = random(minSpeed, maxSpeed) * intensity
       - vx = cos(angle) * speed
       - vy = sin(angle) * speed (negative for upward bias)
       - size = random(minSize, maxSize)
       - color = random from colors array
       - life = 1.0, maxLife = lifetime

       Update logic:
       - x += vx * (deltaTime/1000)
       - y += vy * (deltaTime/1000)
       - vy += gravity * (deltaTime/1000)  // gravity pulls down
       - life -= deltaTime / maxLife
       - if life <= 0: active = false

    3. **src/effects/particles/index.ts**: Barrel export
  </action>
  <verify>npm run build succeeds, Particle class exports correctly</verify>
  <done>Particle types and class ready for ParticleSystem</done>
</task>

<task type="auto">
  <name>Task 2: Create ParticleSystem with object pooling</name>
  <files>src/effects/particles/ParticleSystem.ts</files>
  <action>
    Create ParticleSystem class with efficient object pooling:

    ```ts
    export class ParticleSystem {
      private particles: Particle[];
      private config: ParticleConfig;

      constructor(config?: Partial<ParticleConfig>);

      // Emit particles at position (typically canvas center)
      emit(x: number, y: number, intensity: number): void;

      // Update all active particles
      update(deltaTime: number): void;

      // Get active particles for rendering
      getActiveParticles(): ParticleState[];

      // Reset all particles
      clear(): void;
    }
    ```

    Implementation details:

    1. **Constructor**: Pre-allocate particle pool (maxParticles Particle instances)
       - All particles start inactive
       - Avoids GC pressure from creating/destroying particles

    2. **emit()**: Find inactive particles, spawn emitCount of them
       - Scale emitCount by intensity (more particles on stronger beats)
       - actualCount = Math.floor(emitCount * (0.5 + intensity * 0.5))
       - Loop through pool, spawn first N inactive particles
       - If pool exhausted, oldest particles get recycled

    3. **update(deltaTime)**: Update all active particles
       - Call particle.update(deltaTime) for each
       - Particles auto-deactivate when life <= 0

    4. **getActiveParticles()**: Return array of ParticleState for active particles
       - Filter by isAlive()
       - Used by renderer each frame

    Default config:
    ```ts
    const DEFAULT_PARTICLE_CONFIG: ParticleConfig = {
      maxParticles: 200,
      emitCount: 15,
      lifetime: 1500,
      minSize: 2,
      maxSize: 8,
      minSpeed: 50,
      maxSpeed: 200,
      gravity: 100,
      colors: ['#ff00ff', '#00ffff', '#ffff00', '#ff6600', '#00ff00'],
    };
    ```
  </action>
  <verify>npm run build succeeds, ParticleSystem exports and can be instantiated</verify>
  <done>ParticleSystem with object pooling ready for rendering</done>
</task>

<task type="auto">
  <name>Task 3: Create ParticleRenderer component and integrate</name>
  <files>src/effects/ParticleRenderer.tsx, src/visualizers/VisualizerContainer.tsx, src/effects/index.ts</files>
  <action>
    1. **src/effects/ParticleRenderer.tsx**: React component like other visualizers:
       ```tsx
       interface ParticleRendererProps {
         renderer: Renderer | null;
         isBeat: boolean;
         beatIntensity: number;
         width: number;
         height: number;
         enabled?: boolean;
       }

       export function ParticleRenderer({
         renderer,
         isBeat,
         beatIntensity,
         width,
         height,
         enabled = true,
       }: ParticleRendererProps)
       ```

       Implementation:
       - useRef to hold ParticleSystem instance (create once)
       - useEffect to emit on beats when isBeat && enabled
         - Emit from canvas center: emit(width/2, height/2, beatIntensity)
       - Register render callback at layer 'overlay' (after visualizers)

       Render callback:
       ```ts
       const renderParticles = useCallback((ctx: CanvasRenderingContext2D, deltaTime: number) => {
         if (!enabled) return;

         system.update(deltaTime);
         const particles = system.getActiveParticles();

         for (const p of particles) {
           ctx.globalAlpha = p.life; // Fade out as life decreases
           ctx.fillStyle = p.color;
           ctx.beginPath();
           ctx.arc(p.x, p.y, p.size * p.life, 0, Math.PI * 2); // Size shrinks with life
           ctx.fill();
         }

         ctx.globalAlpha = 1; // Reset alpha
       }, [enabled]);
       ```

    2. **Update src/effects/index.ts**: Add ParticleRenderer export

    3. **Update VisualizerContainer.tsx**:
       - Import ParticleRenderer
       - Add particlesEnabled state (default true)
       - Add toggle button "Particles" in selector
       - Render ParticleRenderer alongside other components:
         ```tsx
         <ParticleRenderer
           renderer={renderer}
           isBeat={beatInfo?.isBeat ?? false}
           beatIntensity={beatInfo?.intensity ?? 0}
           width={renderer?.width ?? 800}
           height={renderer?.height ?? 400}
           enabled={particlesEnabled}
         />
         ```

       Position before vignette in render order (particles under vignette looks better).
  </action>
  <verify>npm run dev - load audio, play, verify particles emit on beats</verify>
  <done>Particle system integrated, particles emit on beats and animate smoothly</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete particle system with beat-reactive emission</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Upload an audio file with clear beats
    3. Play the audio
    4. Verify:
       - Particles explode from center on beats
       - Particles move outward/upward, then fall with gravity
       - Particles fade out smoothly over ~1.5 seconds
       - Stronger beats = more particles
       - Toggle "Particles" button enables/disables effect
       - No frame drops or stuttering (smooth 60 FPS)
    5. Try different music genres to test particle feel
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] npm run lint passes (or only pre-existing warnings)
- [ ] Particles emit on beats (visually confirmed)
- [ ] Particles animate: move, fade, shrink
- [ ] No memory leaks (particle pool recycles)
- [ ] 60 FPS maintained with particles active
- [ ] Human verification checkpoint passed
</verification>

<success_criteria>

- All tasks completed including human verification
- Particle system feels responsive to beats
- Visual quality matches "rave aesthetic" from presets
- Performance is smooth with 200 active particles
- Particles toggle works correctly
</success_criteria>

<output>
After completion, create `.planning/phases/09-effects/09-02-SUMMARY.md`
</output>
