---
phase: 11-export-pipeline
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/components/ExportPanel.tsx
  - src/components/ExportPanel.css
  - src/visualizers/VisualizerContainer.tsx
  - src/App.tsx
  - src/App.css
autonomous: false

must_haves:
  truths:
    - "User can click Export button to start video export"
    - "User can select resolution (720p or 1080p)"
    - "Export progress is shown during recording"
    - "Exported video downloads automatically when complete"
  artifacts:
    - path: "src/components/ExportPanel.tsx"
      provides: "Export UI with resolution selector and progress"
      min_lines: 60
    - path: "src/components/ExportPanel.css"
      provides: "Export panel styling"
  key_links:
    - from: "ExportPanel.tsx"
      to: "VideoExporter"
      via: "useRef and start/stop methods"
      pattern: "VideoExporter"
    - from: "App.tsx"
      to: "ExportPanel"
      via: "component render with canvas ref"
      pattern: "<ExportPanel"
---

<objective>
Create the export UI component and integrate it into the app.

Purpose: Enable users to export their visualizer as video with resolution selection and progress feedback.

Output: ExportPanel component with resolution selector and progress bar, integrated into App.tsx.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-export-pipeline/11-01-SUMMARY.md

@src/export/types.ts
@src/export/VideoExporter.ts
@src/App.tsx
@src/visualizers/VisualizerContainer.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExportPanel component</name>
  <files>src/components/ExportPanel.tsx, src/components/ExportPanel.css</files>
  <action>
Create ExportPanel component with resolution selector and progress display:

**ExportPanel.tsx:**

Props interface:
- canvas: HTMLCanvasElement | null
- audioEngine: AudioEngine | null
- disabled?: boolean

State:
- selectedResolution: ExportResolution (default 1080p)
- exportProgress: ExportProgress | null
- isExporting: boolean

Component:
1. Resolution selector buttons (720p, 1080p) using EXPORT_RESOLUTIONS
2. Export button - disabled when no audio loaded or already exporting
3. Progress bar shown during export (width based on progress.progress)
4. Status text showing current state (Preparing..., Recording X%, Encoding..., Complete!)
5. Cancel button during recording

Export flow:
- On Export click: create VideoExporter instance, call start() with selected resolution
- VideoExporter callbacks update exportProgress state
- On complete: trigger download using URL.createObjectURL and programmatic anchor click
- On cancel: call exporter.stop()

Download helper:
```typescript
const downloadBlob = (blob: Blob, filename: string) => {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
};
```

Filename format: `beatforge-export-{timestamp}.webm`

**ExportPanel.css:**
- `.export-panel` container with flex layout
- `.export-resolution-selector` button group styling
- `.export-btn` primary action button (green when ready, gray when disabled)
- `.export-progress` progress bar container
- `.export-progress-bar` inner bar with width transition
- `.export-status` status text styling
- Match existing dark theme from other components

Use patterns from existing components (TextEditor, BackgroundEditor) for consistent styling.
  </action>
  <verify>npm run build succeeds, component renders without errors</verify>
  <done>ExportPanel component with resolution selector and progress bar</done>
</task>

<task type="auto">
  <name>Task 2: Expose canvas ref from VisualizerContainer</name>
  <files>src/visualizers/VisualizerContainer.tsx</files>
  <action>
Modify VisualizerContainer to expose canvas ref for export:

1. Add to props interface:
   ```typescript
   /** Ref callback to expose canvas element for export */
   canvasRef?: (canvas: HTMLCanvasElement | null) => void;
   ```

2. Add useEffect to call canvasRef callback when canvas is available:
   ```typescript
   useEffect(() => {
     if (canvasRef) {
       canvasRef(canvasRef.current);
     }
   }, [canvasRef]);
   ```

Actually, simpler approach - use forwardRef or just pass the callback:
- Keep internal canvasRef as useRef
- In useEffect, call the prop callback with current canvas element
- Handle null case when unmounting

The parent (App) needs access to the canvas element to pass to VideoExporter.
  </action>
  <verify>npm run build succeeds, VisualizerContainer accepts canvasRef prop</verify>
  <done>Canvas element accessible to parent for export</done>
</task>

<task type="auto">
  <name>Task 3: Integrate ExportPanel into App</name>
  <files>src/App.tsx, src/App.css</files>
  <action>
Add ExportPanel to App.tsx:

1. Import ExportPanel and related types
2. Add state for canvas element: `const [canvasElement, setCanvasElement] = useState<HTMLCanvasElement | null>(null);`
3. Add ExportPanel to JSX after BackgroundEditor:
   ```tsx
   <ExportPanel
     canvas={canvasElement}
     audioEngine={audioEngine}
     disabled={isLoading}
   />
   ```
4. Pass canvasRef callback to VisualizerContainer:
   ```tsx
   <VisualizerContainer
     ...existing props
     canvasRef={setCanvasElement}
   />
   ```

**App.css updates:**
- Add spacing for export panel section
- Ensure export panel is visible in the control flow

Position ExportPanel after background editor, before visualizer container in the visual hierarchy.
  </action>
  <verify>npm run build succeeds, npm run lint passes</verify>
  <done>ExportPanel integrated and visible in app</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Video export pipeline with resolution selection and progress indicator</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Upload an audio file (use a short ~30 second clip for faster testing)
    3. Let it play briefly to verify visualizer works
    4. Find the Export section below background editor
    5. Select resolution (720p or 1080p)
    6. Click Export button
    7. Verify: Progress bar appears and updates during recording
    8. Verify: Audio plays during export (recording the visualizer)
    9. Wait for export to complete
    10. Verify: WebM file downloads automatically
    11. Open downloaded file in VLC or browser
    12. Verify: Video plays with audio synced to visuals
  </how-to-verify>
  <resume-signal>Type "approved" if export works with synced audio-video, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `npm run lint` passes
- [ ] ExportPanel renders with resolution selector
- [ ] Export button triggers recording
- [ ] Progress bar shows during export
- [ ] WebM file downloads on completion
- [ ] Exported video has synced audio
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human verification of export quality approved
- Exported WebM plays correctly with synced audio
</success_criteria>

<output>
After completion, create `.planning/phases/11-export-pipeline/11-02-SUMMARY.md`
</output>
