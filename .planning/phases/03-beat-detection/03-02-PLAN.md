---
phase: 03-beat-detection
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/hooks/useBeatDetector.ts
  - src/components/BeatDebug.tsx
  - src/components/BeatDebug.css
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "React components can subscribe to beat data via useBeatDetector hook"
    - "Debug visualization shows frequency bars updating in real-time"
    - "Beat indicator flashes on detected beats"
    - "Analysis runs at 60 FPS without lag"
  artifacts:
    - path: "src/hooks/useBeatDetector.ts"
      provides: "React hook for beat detection data"
      exports: ["useBeatDetector"]
    - path: "src/components/BeatDebug.tsx"
      provides: "Debug visualization component"
      min_lines: 50
  key_links:
    - from: "src/hooks/useBeatDetector.ts"
      to: "src/audio/AudioEngine.ts"
      via: "onBeatInfo callback"
      pattern: "onBeatInfo"
    - from: "src/components/BeatDebug.tsx"
      to: "src/hooks/useBeatDetector.ts"
      via: "hook consumption"
      pattern: "useBeatDetector"
---

<objective>
Create React integration for beat detection with a debug visualization to verify the system works.

Purpose: Enable React components to consume beat data and visually verify beat detection is working correctly.
Output: useBeatDetector hook and BeatDebug component showing real-time frequency analysis.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-beat-detection/03-01-SUMMARY.md

@src/audio/AudioEngine.ts
@src/audio/types.ts
@src/audio/BeatDetector.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useBeatDetector hook</name>
  <files>src/hooks/useBeatDetector.ts</files>
  <action>
Create a React hook that provides beat detection data to components:

```typescript
import { useState, useEffect, useCallback } from 'react';
import type { BeatInfo, FrequencyBands } from '../audio/types';
import type { AudioEngine } from '../audio/AudioEngine';

interface UseBeatDetectorResult {
  beatInfo: BeatInfo | null;
  frequencyBands: FrequencyBands | null;
  isBeat: boolean;
  beatCount: number;
}

export function useBeatDetector(audioEngine: AudioEngine | null): UseBeatDetectorResult
```

Implementation:
1. Use useState for beatInfo, tracking the latest BeatInfo from callback
2. Track beatCount (increments on each detected beat)
3. Subscribe to audioEngine callbacks in useEffect:
   - Set the audioEngine's onBeatInfo callback to update state
   - Clean up by setting callback to undefined on unmount
4. Return derived values: beatInfo, frequencyBands, isBeat shorthand, beatCount

NOTE: The hook receives audioEngine as prop because App.tsx manages the engine instance.
The callback approach (not direct polling) ensures we don't miss beat events.

Create the hooks directory if it doesn't exist.
  </action>
  <verify>npm run build succeeds</verify>
  <done>useBeatDetector hook exports and compiles without errors</done>
</task>

<task type="auto">
  <name>Task 2: Create BeatDebug visualization component</name>
  <files>src/components/BeatDebug.tsx, src/components/BeatDebug.css</files>
  <action>
Create a debug visualization component showing beat detection in action:

BeatDebug.tsx:
```typescript
interface BeatDebugProps {
  beatInfo: BeatInfo | null;
  beatCount: number;
}

export function BeatDebug({ beatInfo, beatCount }: BeatDebugProps)
```

Visual elements:
1. Three vertical bars for bass/mid/treble (height reflects energy 0-100%)
2. Beat indicator circle that flashes red on beat detection
3. Beat count display
4. Numeric readouts for each band (optional, small text)

Layout (horizontal):
```
[BASS] [MID] [TREBLE]  (‚óè)  Beats: 42
  80%   45%    30%     BEAT!
```

BeatDebug.css styling:
- Dark container background (#1a1a2e or similar)
- Frequency bars: colored (bass=red, mid=green, treble=blue), max height ~100px
- Beat indicator: circle that scales up and turns red on beat, then fades
- Use CSS transition for smooth bar movement
- Beat flash animation: quick scale + color change

CSS animation for beat:
```css
.beat-indicator.active {
  transform: scale(1.5);
  background-color: #ff4444;
}
```

The component should be purely presentational - receives data as props.
  </action>
  <verify>npm run build succeeds</verify>
  <done>BeatDebug component renders frequency bars and beat indicator</done>
</task>

<task type="auto">
  <name>Task 3: Integrate BeatDebug into App</name>
  <files>src/App.tsx, src/App.css</files>
  <action>
Add the beat debug visualization to App.tsx:

1. Import useBeatDetector hook and BeatDebug component
2. Call useBeatDetector(audioEngine) to get beat data
3. Render BeatDebug component below the audio player (only when audio is loaded)

```tsx
import { useBeatDetector } from './hooks/useBeatDetector';
import { BeatDebug } from './components/BeatDebug';

function App() {
  // ... existing audioEngine setup

  const { beatInfo, beatCount } = useBeatDetector(audioEngine);

  return (
    <div className="app">
      {/* ... existing AudioUpload and AudioPlayer */}

      {audioState !== 'idle' && audioState !== 'loading' && (
        <BeatDebug beatInfo={beatInfo} beatCount={beatCount} />
      )}
    </div>
  );
}
```

Add minimal CSS in App.css to position the debug panel (centered below player, with margin).
  </action>
  <verify>npm run dev starts without errors, component renders</verify>
  <done>BeatDebug visible in app when audio is loaded</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Beat detection system with debug visualization showing frequency bars and beat indicator</what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Open: http://localhost:5173 (or the port shown)
    3. Upload an audio file (preferably something with clear beats, like EDM or hip-hop)
    4. Click Play
    5. Observe the BeatDebug panel:
       - Frequency bars (bass/mid/treble) should move with the music
       - Bass bar should be most active on kick drums
       - Beat indicator should flash on strong beats
       - Beat count should increment
    6. Verify responsiveness:
       - Bars should update smoothly (60 FPS, no jitter)
       - Beat detection should feel "on time" with the music
       - No audio lag or stuttering
    7. Try seeking - beat detection should continue working after seek
  </how-to-verify>
  <resume-signal>Type "approved" if beat detection works correctly, or describe any issues (e.g., "beats fire too often", "no beats detected", "laggy animation")</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds
- [ ] `npm run lint` passes
- [ ] useBeatDetector hook returns beatInfo during playback
- [ ] BeatDebug shows animated frequency bars
- [ ] Beat indicator flashes on detected beats
- [ ] Human verified beat detection feels correct
</verification>

<success_criteria>
- All tasks completed
- useBeatDetector hook provides beat data to React components
- BeatDebug visualization shows real-time frequency analysis
- Beat detection fires on audible beats
- 60 FPS performance maintained
- Human verified the beat detection quality
</success_criteria>

<output>
After completion, create `.planning/phases/03-beat-detection/03-02-SUMMARY.md`
</output>
