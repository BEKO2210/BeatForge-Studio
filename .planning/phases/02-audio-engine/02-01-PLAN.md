---
phase: 02-audio-engine
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/audio/AudioEngine.ts
  - src/audio/types.ts
  - src/components/AudioUpload.tsx
  - src/components/AudioUpload.css
  - src/components/AudioPlayer.tsx
  - src/components/AudioPlayer.css
  - src/App.tsx
  - src/App.css
autonomous: true

must_haves:
  truths:
    - "User can drag-drop or select MP3/WAV file and it loads"
    - "Audio plays when play button is clicked"
    - "Audio pauses when pause button is clicked"
    - "Clicking seek bar jumps to that position in track"
    - "Current time and total duration are displayed and update during playback"
  artifacts:
    - path: "src/audio/AudioEngine.ts"
      provides: "Web Audio API wrapper for loading and controlling audio"
      exports: ["AudioEngine"]
      min_lines: 80
    - path: "src/components/AudioUpload.tsx"
      provides: "Drag-drop and file picker for audio files"
      min_lines: 40
    - path: "src/components/AudioPlayer.tsx"
      provides: "Playback controls with play/pause, seek, time display"
      min_lines: 60
  key_links:
    - from: "src/components/AudioUpload.tsx"
      to: "src/audio/AudioEngine.ts"
      via: "loadFile method call"
      pattern: "audioEngine.*load"
    - from: "src/components/AudioPlayer.tsx"
      to: "src/audio/AudioEngine.ts"
      via: "play/pause/seek method calls"
      pattern: "audioEngine.*(play|pause|seek)"
---

<objective>
Implement audio upload, playback, and Web Audio API integration for BeatForge Studio.

Purpose: Enable users to load their music files and control playback - the foundation for all visualizer features.
Output: AudioEngine class + upload component + player controls integrated into the app.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

@src/App.tsx
@src/App.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AudioEngine with Web Audio API</name>
  <files>src/audio/AudioEngine.ts, src/audio/types.ts</files>
  <action>
Create the audio engine foundation:

**src/audio/types.ts:**
- AudioState type: 'idle' | 'loading' | 'ready' | 'playing' | 'paused'
- AudioEngineCallbacks interface: onStateChange, onTimeUpdate, onError

**src/audio/AudioEngine.ts:**
- Class AudioEngine with:
  - Private AudioContext (create lazily on first user interaction to avoid autoplay policy)
  - Private AudioBufferSourceNode for playback
  - Private GainNode for volume control
  - Private audioBuffer: AudioBuffer | null
  - Private state: AudioState
  - Private startTime and pauseOffset for accurate seek
  - Constructor accepts callbacks
  - async loadFile(file: File): Promise<void> - validate MP3/WAV, decode with decodeAudioData
  - play(): void - create source, connect nodes, start from pauseOffset
  - pause(): void - stop source, save current position
  - seek(time: number): void - set pauseOffset, restart if playing
  - getCurrentTime(): number - calculate from startTime and context.currentTime
  - getDuration(): number - return audioBuffer.duration or 0
  - getState(): AudioState
  - dispose(): void - cleanup

Key implementation details:
- Create new AudioContext only on first loadFile call (user gesture required)
- Create new source node on each play() (source nodes are single-use)
- Track playback position: startTime = context.currentTime, pauseOffset for resume
- Call onTimeUpdate callback in a requestAnimationFrame loop when playing
- Validate file type by MIME or extension before decoding
  </action>
  <verify>TypeScript compiles: npm run build</verify>
  <done>AudioEngine class exports, handles load/play/pause/seek, tracks time accurately</done>
</task>

<task type="auto">
  <name>Task 2: Create AudioUpload component</name>
  <files>src/components/AudioUpload.tsx, src/components/AudioUpload.css</files>
  <action>
Create drag-drop zone with file picker fallback:

**src/components/AudioUpload.tsx:**
- Props: onFileSelect: (file: File) => void, disabled?: boolean
- State: isDragging for visual feedback
- Drag-drop handlers: onDragOver, onDragLeave, onDrop
- Hidden file input with accept=".mp3,.wav,audio/mpeg,audio/wav"
- Click on zone triggers file input click
- Validate file type before calling onFileSelect
- Show different content when disabled (e.g., "Loading...")

**src/components/AudioUpload.css:**
- Dark theme matching App.css (#0a0a0a background)
- Dashed border upload zone, centered content
- Hover/drag-over state: highlighted border (e.g., #646cff)
- Icon or text indicating drop zone
- Disabled state styling
  </action>
  <verify>npm run build succeeds, component renders in isolation</verify>
  <done>AudioUpload accepts drag-drop and click, validates file types, calls onFileSelect</done>
</task>

<task type="auto">
  <name>Task 3: Create AudioPlayer controls and integrate</name>
  <files>src/components/AudioPlayer.tsx, src/components/AudioPlayer.css, src/App.tsx, src/App.css</files>
  <action>
Create player controls and wire everything together:

**src/components/AudioPlayer.tsx:**
- Props: audioEngine: AudioEngine, disabled?: boolean
- Display: current time / duration (format as MM:SS)
- Play/Pause toggle button (show appropriate icon based on state)
- Seek bar (input type="range") from 0 to duration, value = currentTime
- Use audioEngine callbacks to update UI (onStateChange, onTimeUpdate)
- Seek bar onChange calls audioEngine.seek()
- Styled controls in horizontal layout

**src/components/AudioPlayer.css:**
- Dark theme, horizontal flex layout
- Time display: monospace font for alignment
- Play/pause button: styled, hover state
- Seek bar: custom styled (track and thumb) for dark theme
- Disabled state: reduced opacity

**src/App.tsx updates:**
- Create AudioEngine instance (useRef to persist across renders)
- State: audioState, currentTime, duration
- Wire callbacks to update state
- Conditional rendering:
  - Show AudioUpload when state is 'idle'
  - Show AudioPlayer when audio is loaded
- Pass audioEngine to player

**src/App.css updates:**
- Update .app-main to accommodate player layout
- Add container for audio controls
  </action>
  <verify>npm run dev, upload an MP3, verify play/pause works, seek bar moves during playback</verify>
  <done>Full audio workflow: upload file, see player, play/pause/seek works, time displays correctly</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds without errors
- [ ] npm run lint passes (or only minor warnings)
- [ ] Upload MP3 file via drag-drop - audio loads
- [ ] Upload WAV file via file picker - audio loads
- [ ] Play button starts playback
- [ ] Pause button stops playback, resumes from same position
- [ ] Seek bar reflects current position during playback
- [ ] Clicking seek bar jumps to that position
- [ ] Time display shows current/duration in MM:SS format
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- AudioEngine properly manages Web Audio API lifecycle
- UI provides clear feedback for all states (idle, loading, ready, playing, paused)
- No console errors during normal operation
</success_criteria>

<output>
After completion, create `.planning/phases/02-audio-engine/02-01-SUMMARY.md`
</output>
